<!DOCTYPE html>
<html>

<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <meta charset=utf-8 />
    <title>Tele Education</title>
</head>

<body>
    <input type='file' id="asd" />
    <br>
    <img id="img" src="//placehold.it/1x1/" />
    <div id="base"></div>
</body>

<script type="text/javascript">
    //Transfer local image to base64 format
    makeblob = function (dataURL) {
        var BASE64_MARKER = ';base64,';
        if (dataURL.indexOf(BASE64_MARKER) == -1) {
            var parts = dataURL.split(',');
            var contentType = parts[0].split(':')[1];
            var raw = decodeURIComponent(parts[1]);
            return new Blob([raw], {
                type: contentType
            });
        }
        var parts = dataURL.split(BASE64_MARKER);
        var contentType = parts[0].split(':')[1];
        var raw = window.atob(parts[1]);
        var rawLength = raw.length;

        var uInt8Array = new Uint8Array(rawLength);

        for (var i = 0; i < rawLength; ++i) {
            uInt8Array[i] = raw.charCodeAt(i);
        }

        return new Blob([uInt8Array], {
            type: contentType
        });
    }

    // Get elem by ID
    function el(id) {
        return document.getElementById(id);
    }

    //read the uploaded image
    function readImage() {
        if (this.files && this.files[0]) {
            var FR = new FileReader();
            FR.onload = function (e) {
                el("img").src = e.target.result;
                el("base").innerHTML = e.target.result;
                base64 = e.target.result;
                //Azure cal, may need modification
                processImage(e);
            };
            FR.readAsDataURL(this.files[0]);
        }
    }

    el("asd").addEventListener("change", readImage, false);


    //Use base64 format to call Azure API
    function processImage(e) {
        //HT's Azure Key
        var subscriptionKey = "ada93053017649d5b729353cd413d0c8";
        var uriBase =
            "https://practicum1.cognitiveservices.azure.com/face/v1.0/detect";

        // Request parameters.
        var params = {
            "detectionModel": "detection_01",
            "returnFaceId": "true",
            "returnFaceAttributes": "emotion"
        };

        console.log(makeblob(e.target.result));

        // Perform the REST API call.
        $.ajax({
                url: uriBase + "?" + $.param(params),

                // Request headers.
                beforeSend: function (xhrObj) {
                    // xhrObj.setRequestHeader("Content-Type", "application/json");
                    xhrObj.setRequestHeader("Content-Type", "application/octet-stream");
                    xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key", subscriptionKey);
                },

                type: "POST",

                data: makeblob(e.target.result),
                processData: false
            })

            .done(function (data) {
                // Show formatted JSON on webpage.
                $("#responseTextArea").val(JSON.stringify(data, null, 2));
            })

            .fail(function (jqXHR, textStatus, errorThrown) {
                // Display error message.
                var errorString = (errorThrown === "") ?
                    "Error. " : errorThrown + " (" + jqXHR.status + "): ";
                errorString += (jqXHR.responseText === "") ?
                    "" : (jQuery.parseJSON(jqXHR.responseText).message) ?
                    jQuery.parseJSON(jqXHR.responseText).message :
                    jQuery.parseJSON(jqXHR.responseText).error.message;
                alert(errorString);
            });
    };
</script>

<h1>Detect Faces:</h1>
<div id="wrapper" style="width:1020px; display:table;">
    <div id="jsonOutput" style="width:600px; display:table-cell;">
        Response:<br><br>
        <textarea id="responseTextArea" class="UIInput" style="width:580px; height:400px;"></textarea>
    </div>
</div>

</html>